<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cryptographic Key Generation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .main-header {
            font-size: 2.5rem;
            color: #1f77b4;
            text-align: center;
            margin-bottom: 2rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 1rem;
            border-radius: 10px;
            color: white;
            text-align: center;
            margin: 0.5rem 0;
        }
        .sidebar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .sidebar a {
            color: white;
            text-decoration: none;
            padding: 10px;
            display: block;
            border-radius: 5px;
            margin-bottom: 5px;
        }
        .sidebar a:hover, .sidebar a.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        .content {
            padding: 20px;
        }
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 sidebar">
                <h4 class="text-white mb-4">ðŸš€ Navigation</h4>
                <a href="/"><i class="fas fa-home"></i> Dashboard</a>
                <a href="/crypto" class="active"><i class="fas fa-key"></i> Cryptographic Keys</a>
                <a href="/ids"><i class="fas fa-shield-alt"></i> Intrusion Detection</a>
                <a href="/analytics"><i class="fas fa-chart-bar"></i> Analytics</a>
            </div>
            
            <!-- Main Content -->
            <div class="col-md-9 content">
                <h1 class="main-header">ðŸ”‘ Cryptographic Key Generation</h1>
                
                <div class="row">
                    <!-- Configuration Panel -->
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-cogs"></i> Configuration</h5>
                            </div>
                            <div class="card-body">
                                <form id="keyGenForm">
                                    <div class="mb-3">
                                        <label for="keyType" class="form-label">Key Type</label>
                                        <select class="form-select" id="keyType" name="key_type">
                                            <option value="AES">AES</option>
                                            <option value="RSA">RSA</option>
                                            <option value="ECC">ECC</option>
                                            <option value="Hybrid">Hybrid</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="keySize" class="form-label">Key Size</label>
                                        <select class="form-select" id="keySize" name="key_size">
                                            <option value="128" data-key-types="AES,ECC">128 (AES, ECC)</option>
                                            <option value="192" data-key-types="AES">192 (AES)</option>
                                            <option value="256" data-key-types="AES,ECC" selected>256 (AES, ECC)</option>
                                            <option value="512" data-key-types="RSA">512 (RSA)</option>
                                            <option value="1024" data-key-types="RSA">1024 (RSA)</option>
                                            <option value="2048" data-key-types="RSA" selected>2048 (RSA)</option>
                                            <option value="4096" data-key-types="RSA">4096 (RSA)</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="numKeys" class="form-label">Number of Keys</label>
                                        <input type="range" class="form-range" id="numKeys" name="num_keys" min="1" max="10" value="3">
                                        <div class="text-center">
                                            <span id="numKeysValue">3</span> keys
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3 form-check">
                                        <input type="checkbox" class="form-check-input" id="mlOptimization" name="use_ml_optimization" checked>
                                        <label class="form-check-label" for="mlOptimization">
                                            Use Hash-based Enhancement
                                        </label>
                                    </div>
                                </form>
                                
                                <!-- Input Data Section -->
                                <hr>
                                <h6>Input Data</h6>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="inputMethod" id="textInput" value="text" checked>
                                        <label class="form-check-label" for="textInput">
                                            Text Input
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="inputMethod" id="fileUpload" value="file">
                                        <label class="form-check-label" for="fileUpload">
                                            File Upload
                                        </label>
                                    </div>
                                </div>
                                
                                <div id="textInputSection">
                                    <textarea class="form-control" id="inputData" rows="3" placeholder="Enter text data for entropy...">Sample data for key generation</textarea>
                                </div>
                                
                                <div id="fileUploadSection" style="display: none;">
                                    <input class="form-control" type="file" id="fileInput" accept=".txt,.csv,.json,.png,.jpg,.jpeg">
                                </div>
                                
                                <button type="button" class="btn btn-primary w-100 mt-3" onclick="generateKeys()">
                                    <i class="fas fa-key"></i> Generate Keys
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Results Panel -->
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-chart-line"></i> Results & Metrics</h5>
                            </div>
                            <div class="card-body">
                                <div id="resultsContent">
                                    <div class="text-center text-muted py-5">
                                        <i class="fas fa-search fa-3x mb-3"></i>
                                        <p>Generate keys to see results and metrics here.</p>
                                    </div>
                                </div>
                                
                                <!-- Metrics Display -->
                                <div id="metricsDisplay" style="display: none;">
                                    <div class="row mb-4">
                                        <div class="col-md-4">
                                            <div class="metric-card">
                                                <h6>Generation Time</h6>
                                                <h4 id="generationTime">-</h4>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="metric-card">
                                                <h6>Encoding Time</h6>
                                                <h4 id="encodingTime">-</h4>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="metric-card">
                                                <h6>CPU Cycles</h6>
                                                <h4 id="cpuCycles">-</h4>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row mb-4">
                                        <div class="col-md-4">
                                            <div class="metric-card">
                                                <h6>Decoding Time</h6>
                                                <h4 id="decodingTime">-</h4>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="metric-card">
                                                <h6>Entropy Score</h6>
                                                <h4 id="entropyScore">-</h4>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="metric-card">
                                                <h6>Attack Success Rate</h6>
                                                <h4 id="attackRate">-</h4>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Charts -->
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h6>Key Strength Analysis</h6>
                                                    <div class="chart-container">
                                                        <canvas id="strengthChart"></canvas>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h6>Performance Comparison</h6>
                                                    <div class="chart-container">
                                                        <canvas id="performanceChart"></canvas>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Generated Keys Display -->
                                <div id="generatedKeysSection" style="display: none;">
                                    <hr>
                                    <h6><i class="fas fa-key"></i> Generated Keys</h6>
                                    <div class="card mt-3">
                                        <div class="card-body">
                                            <div id="keysContainer">
                                                <!-- Keys will be displayed here -->
                                            </div>
                                            <div class="mt-3">
                                                <button class="btn btn-sm btn-secondary" onclick="copyAllKeys()">
                                                    <i class="fas fa-copy"></i> Copy All Keys
                                                </button>
                                                <button class="btn btn-sm btn-info" onclick="downloadKeys()">
                                                    <i class="fas fa-download"></i> Download Keys
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <i class="fas fa-spinner fa-spin fa-3x text-primary mb-3"></i>
                    <h5>Generating Cryptographic Keys...</h5>
                    <p class="text-muted">This may take a few moments</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Update slider value display
        // Update key size options based on selected key type
        function updateKeySizeOptions() {
            const keyType = document.getElementById('keyType').value;
            const keySizeSelect = document.getElementById('keySize');
            const currentValue = keySizeSelect.value;
            
            // Show/hide options based on key type
            for (let i = 0; i < keySizeSelect.options.length; i++) {
                const option = keySizeSelect.options[i];
                const validForType = option.dataset.keyTypes && option.dataset.keyTypes.includes(keyType);
                option.hidden = !validForType;
                
                // Select first visible option if current selection is invalid
                if (validForType && !keySizeSelect.value) {
                    keySizeSelect.selectedIndex = i;
                }
            }
            
            // If current selection is not valid for this key type, select first valid option
            const currentOption = keySizeSelect.options[keySizeSelect.selectedIndex];
            if (currentOption.hidden) {
                for (let i = 0; i < keySizeSelect.options.length; i++) {
                    if (!keySizeSelect.options[i].hidden) {
                        keySizeSelect.selectedIndex = i;
                        break;
                    }
                }
            }
        }
        
        // Initialize key size options
        updateKeySizeOptions();
        
        // Update key size options when key type changes
        document.getElementById('keyType').addEventListener('change', updateKeySizeOptions);
        
        // Update number of keys display
        document.getElementById('numKeys').addEventListener('input', function() {
            document.getElementById('numKeysValue').textContent = this.value;
        });

        // Toggle input method
        document.querySelectorAll('input[name="inputMethod"]').forEach(function(radio) {
            radio.addEventListener('change', function() {
                if (this.value === 'text') {
                    document.getElementById('textInputSection').style.display = 'block';
                    document.getElementById('fileUploadSection').style.display = 'none';
                } else {
                    document.getElementById('textInputSection').style.display = 'none';
                    document.getElementById('fileUploadSection').style.display = 'block';
                }
            });
        });

        async function generateKeys() {
            const modal = new bootstrap.Modal(document.getElementById('loadingModal'));
            modal.show();

            try {
                
                // Handle input data
                let inputData = document.getElementById('inputData').value;
                const inputMethod = document.querySelector('input[name="inputMethod"]:checked').value;
                
                if (inputMethod === 'file') {
                    const fileInput = document.getElementById('fileInput');
                    if (fileInput.files.length > 0) {
                        // First upload the file
                        const fileFormData = new FormData();
                        fileFormData.append('file', fileInput.files[0]);
                        
                        const fileResponse = await fetch('/api/upload-file', {
                            method: 'POST',
                            body: fileFormData
                        });
                        
                        const fileData = await fileResponse.json();
                        if (fileData.success) {
                }

                if (!response.ok) {
                    throw new Error(`Request failed: ${response.status}`);
                }

                let data;
                try {
                    data = await response.json();
                } catch (e) {
                    throw new Error('Invalid JSON response from server');
                }
                
                // Process the response data
                if (data.success) {
                    try {
                        // Safely update metrics display with null checks
                        const safeToFixed = (value, decimals = 2) => {
                            return value !== undefined && value !== null ? value.toFixed(decimals) : 'N/A';
                        };
                        
                        // Update metrics display with null checks
                        document.getElementById('generationTime').textContent = 
                            data.results.generation_time !== undefined ? 
                            safeToFixed(data.results.generation_time, 2) + ' ms' : 'N/A';
                            
                        document.getElementById('encodingTime').textContent = 
                            data.results.encoding_time !== undefined ? 
                            safeToFixed(data.results.encoding_time, 2) + ' ms' : 'N/A';
                            
                        document.getElementById('decodingTime').textContent = 
                            data.results.decoding_time !== undefined ? 
                            safeToFixed(data.results.decoding_time, 2) + ' ms' : 'N/A';
                            
                        document.getElementById('cpuCycles').textContent = 
                            data.results.cpu_cycles !== undefined ? 
                            data.results.cpu_cycles.toLocaleString() : 'N/A';
                            
                        document.getElementById('entropyScore').textContent = 
                            data.results.entropy_score !== undefined ? 
                            safeToFixed(data.results.entropy_score, 4) : 'N/A';
                            
                        document.getElementById('attackRate').textContent = 
                            data.results.attack_success_rate !== undefined ? 
                            safeToFixed(data.results.attack_success_rate * 100, 2) + '%' : 'N/A';
                        
                        // Show metrics and generated keys sections
                        document.getElementById('metricsDisplay').style.display = 'block';
                        document.getElementById('generatedKeysSection').style.display = 'block';
                        
                        // Display the generated keys
                        if (data.results.keys && data.results.keys.length > 0) {
                            displayGeneratedKeys(data.results.keys);
                        }
                        
                        // Update charts if they exist in the DOM
                        const metricsDisplay = document.getElementById('metricsDisplay');
                        if (metricsDisplay) {
                            if (strengthChartInstance) {
                                strengthChartInstance.destroy();
                            }
                            strengthChartInstance = createStrengthChart();
                            
                            if (performanceChartInstance) {
                                performanceChartInstance.destroy();
                            }
                            performanceChartInstance = createPerformanceChart();
                            
                            // Scroll to results
                            metricsDisplay.scrollIntoView({ behavior: 'smooth' });
                        }
                        
                    } catch (uiErr) {
                        console.error('UI rendering error:', uiErr);
                        alert('Keys generated, but failed to render results on page. Check console.');
                    }
                } else {
                    throw new Error(data.message || 'Failed to generate keys');
                }
            } catch (error) {
                alert('Error generating keys: ' + error.message);
                console.error('Key generation error:', error);
            } finally {
                modal.hide();
            }
        }

        let generatedKeysData = []; // Store keys globally

        let strengthChartInstance = null;
        let performanceChartInstance = null;

        function displayResults(results) {
            console.log('Display Results called with:', results);
            console.log('Keys in results:', results.keys);
            
            // Update metrics
            const gen = Number(results?.generation_time || 0);
            const enc = Number(results?.encoding_time || 0);
            const dec = Number(results?.decoding_time || 0);
            const cpu = Number(results?.cpu_cycles || 0);
            const ent = Number(results?.entropy_score || 0);
            const atk = Number(results?.attack_success_rate || 0);

            document.getElementById('generationTime').textContent = gen.toFixed(2) + ' ms';
            document.getElementById('encodingTime').textContent = enc.toFixed(2) + ' ms';
            document.getElementById('decodingTime').textContent = dec.toFixed(2) + ' ms';
            document.getElementById('cpuCycles').textContent = cpu.toLocaleString();
            document.getElementById('entropyScore').textContent = ent.toFixed(4);
            document.getElementById('attackRate').textContent = atk.toFixed(2) + '%';

            // Store keys data
            generatedKeysData = results.keys || [];
            console.log('Stored keys data:', generatedKeysData);

            // Display generated keys
            displayGeneratedKeys(generatedKeysData);

            // Show metrics display
            document.getElementById('resultsContent').style.display = 'none';
            document.getElementById('metricsDisplay').style.display = 'block';
            document.getElementById('generatedKeysSection').style.display = 'block';

            // Create charts
            try {
                createStrengthChart();
            } catch (e) {
                console.warn('Strength chart render failed:', e);
            }
            try {
                createPerformanceChart();
            } catch (e) {
                console.warn('Performance chart render failed:', e);
            }
        }

        function safeToFixed(value, decimals = 2, fallback = 'N/A') {
            return (value !== undefined && value !== null && !isNaN(value)) 
                ? Number(value).toFixed(decimals) 
                : fallback;
        }

        function displayGeneratedKeys(keys) {
            console.log('displayGeneratedKeys called with keys:', keys);
            const container = document.getElementById('keysContainer');
            if (!container) {
                console.error('keysContainer element not found');
                return;
            }
            container.innerHTML = '';

            if (!keys || !Array.isArray(keys) || keys.length === 0) {
                console.log('No keys found or empty keys array');
                container.innerHTML = '<p class="text-muted">No keys generated</p>';
                return;
            }

            console.log(`Processing ${keys.length} keys`);
            keys.forEach((key, index) => {
                if (!key) return;
                
                console.log(`Processing key ${index + 1}:`, key);
                const keyDiv = document.createElement('div');
                keyDiv.className = 'mb-3 p-3 border rounded';
                
                const keyType = key.key_type || 'UNKNOWN';
                const keySize = key.key_size || 'N/A';
                const genTime = safeToFixed(key.generation_time, 2, '0.00');
                const entropy = safeToFixed(key.entropy, 4, '0.0000');
                const strength = safeToFixed(100 - (key.attack_success_rate || 0), 1, '100.0');
                
                let keyContent = '';
                
                if (keyType.toUpperCase() === 'AES') {
                    console.log('Processing AES key');
                    keyContent = `
                        <h6><i class="fas fa-shield-alt"></i> ${keyType} Key #${index + 1}</h6>
                        <p><strong>Size:</strong> ${keySize} bits</p>
                        <p><strong>Key:</strong></p>
                        <div class="bg-light p-2 rounded" style="font-family: monospace; font-size: 0.8rem; word-break: break-all;">
                            ${key.key || 'No key data available'}
                        </div>
                        <small class="text-muted">
                            Generation: ${genTime}ms | 
                            Entropy: ${entropy} | 
                            Strength: ${strength}%
                        </small>
                    `;
                } else if (keyType === 'RSA' || keyType === 'ECC') {
                    keyContent = `
                        <h6><i class="fas fa-key"></i> ${keyType} Key Pair #${index + 1}</h6>
                        <p><strong>Size:</strong> ${keySize} ${key.curve ? '(' + key.curve + ')' : ''}</p>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Private Key:</strong></p>
                                <div class="bg-light p-2 rounded" style="font-family: monospace; font-size: 0.7rem; max-height: 200px; overflow-y: auto;">
                                    ${key.private_key || 'No private key data'}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Public Key:</strong></p>
                                <div class="bg-light p-2 rounded" style="font-family: monospace; font-size: 0.7rem; max-height: 200px; overflow-y: auto;">
                                    ${key.public_key || 'No public key data'}
                                </div>
                            </div>
                        </div>
                        <small class="text-muted">
                            Generation: ${genTime}ms | 
                            Entropy: ${entropy} | 
                            Strength: ${strength}%
                        </small>
                    `;
                } else if (key.key_type === 'Hybrid') {
                    keyContent = `
                        <h6><i class="fas fa-cogs"></i> Hybrid Key System #${index + 1}</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <h6>AES Component</h6>
                                <div class="bg-light p-2 rounded" style="font-family: monospace; font-size: 0.8rem; word-break: break-all;">
                                    ${key.aes_key.key}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>RSA Component</h6>
                                <div class="bg-light p-2 rounded" style="font-family: monospace; font-size: 0.7rem; max-height: 150px; overflow-y: auto;">
                                    ${key.rsa_keys.private_key.substring(0, 200)}...
                                </div>
                            </div>
                        </div>
                        <small class="text-muted">
                            Generation: ${key.generation_time.toFixed(2)}ms
                        </small>
                    `;
                }

                keyDiv.innerHTML = keyContent;
                container.appendChild(keyDiv);
            });
        }

        function copyAllKeys() {
            if (!generatedKeysData || generatedKeysData.length === 0) {
                alert('No keys to copy!');
                return;
            }

            let keysText = '=== GENERATED CRYPTOGRAPHIC KEYS ===\n\n';
            generatedKeysData.forEach((key, index) => {
                keysText += `Key #${index + 1} (${key.key_type})\n`;
                if (key.key_type === 'AES') {
                    keysText += `Size: ${key.key_size} bits\n`;
                    keysText += `Key: ${key.key}\n`;
                } else if (key.key_type === 'RSA' || key.key_type === 'ECC') {
                    keysText += `Private Key:\n${key.private_key}\n\n`;
                    keysText += `Public Key:\n${key.public_key}\n`;
                } else if (key.key_type === 'Hybrid') {
                    keysText += `AES Key: ${key.aes_key.key}\n`;
                    keysText += `RSA Private Key:\n${key.rsa_keys.private_key}\n`;
                }
                keysText += `\n${'='.repeat(50)}\n\n`;
            });

            navigator.clipboard.writeText(keysText).then(() => {
                alert('All keys copied to clipboard!');
            }).catch(() => {
                alert('Failed to copy keys to clipboard');
            });
        }

        function downloadKeys() {
            if (!generatedKeysData || generatedKeysData.length === 0) {
                alert('No keys to download!');
                return;
            }

            const keysJson = JSON.stringify(generatedKeysData, null, 2);
            const blob = new Blob([keysJson], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cryptographic_keys_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function createStrengthChart() {
            const canvas = document.getElementById('strengthChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (strengthChartInstance) {
                try { strengthChartInstance.destroy(); } catch (_) {}
            }
            strengthChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['High Entropy', 'Medium Entropy', 'Low Entropy'],
                    datasets: [{
                        data: [70, 25, 5],
                        backgroundColor: ['#28a745', '#ffc107', '#dc3545'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function createPerformanceChart() {
            const canvas = document.getElementById('performanceChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (performanceChartInstance) {
                try { performanceChartInstance.destroy(); } catch (_) {}
            }
            performanceChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Generation', 'Encoding', 'Decoding'],
                    datasets: [{
                        label: 'Time (ms)',
                        data: [
                            parseFloat(document.getElementById('generationTime').textContent),
                            parseFloat(document.getElementById('encodingTime').textContent),
                            parseFloat(document.getElementById('decodingTime').textContent)
                        ],
                        backgroundColor: ['#007bff', '#28a745', '#ffc107'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
